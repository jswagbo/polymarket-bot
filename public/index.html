<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Polymarket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=SF+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'SF Pro Display';
      src: local('-apple-system'), local('BlinkMacSystemFont'), local('SF Pro Display');
    }
    
    :root {
      --white: #ffffff;
      --bg: #f5f5f7;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --border: #d2d2d7;
      --blue: #0071e3;
      --green: #34c759;
      --red: #ff3b30;
      --orange: #ff9500;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 40px 22px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 48px;
    }

    .logo {
      font-size: 21px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .password-field {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      background: var(--white);
      width: 140px;
      font-family: 'SF Mono', 'Menlo', monospace;
      font-size: 13px;
    }

    .password-field:focus {
      outline: 2px solid var(--blue);
      outline-offset: 1px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
    }

    .status.connected .status-dot {
      background: var(--green);
    }

    /* Navigation */
    .nav {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 48px;
    }

    .nav-link {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      padding: 8px 0;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.15s;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
    }

    .nav-link:hover {
      color: var(--text);
    }

    .nav-link.active {
      color: var(--text);
      border-bottom-color: var(--text);
    }

    /* Cards */
    .card {
      background: var(--white);
      border-radius: 18px;
      padding: 28px;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 24px;
    }

    .card-subtitle {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    @media (max-width: 640px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
    }

    .stat {
      background: var(--white);
      padding: 24px 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 34px;
      font-weight: 600;
      font-feature-settings: 'tnum';
      letter-spacing: -0.02em;
      margin-bottom: 4px;
    }

    .stat-value.positive { color: var(--green); }
    .stat-value.negative { color: var(--red); }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    /* Window Status */
    .window-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: var(--white);
      border-radius: 14px;
      margin-bottom: 24px;
    }

    .window-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .window-icon {
      font-size: 32px;
    }

    .window-text strong {
      display: block;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .window-text span {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .window-time {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .minute-display {
      font-size: 40px;
      font-weight: 600;
      font-feature-settings: 'tnum';
      letter-spacing: -0.02em;
    }

    .window-pill {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .window-pill.active {
      background: rgba(52, 199, 89, 0.15);
      color: #248a3d;
    }

    .window-pill.waiting {
      background: rgba(255, 149, 0, 0.15);
      color: #c93400;
    }

    /* Form Controls */
    .form-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0;
      border-bottom: 0.5px solid var(--border);
    }

    .form-row:last-of-type {
      border-bottom: none;
    }

    .form-label {
      font-size: 17px;
      font-weight: 400;
    }

    .form-sublabel {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .toggle {
      width: 51px;
      height: 31px;
      background: #e9e9eb;
      border-radius: 31px;
      position: relative;
      cursor: pointer;
      transition: background 0.25s;
    }

    .toggle.on {
      background: var(--green);
    }

    .toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 27px;
      height: 27px;
      background: var(--white);
      border-radius: 50%;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 1px 1px rgba(0,0,0,0.16);
      transition: transform 0.25s;
    }

    .toggle.on::after {
      transform: translateX(20px);
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .field-input {
      padding: 12px 16px;
      border: 0.5px solid var(--border);
      border-radius: 10px;
      font-size: 17px;
      font-family: 'SF Mono', 'Menlo', monospace;
      background: var(--white);
    }

    .field-input:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 22px;
      border-radius: 980px;
      font-size: 17px;
      font-weight: 400;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--blue);
      color: var(--white);
    }

    .btn-primary:hover {
      background: #0077ed;
    }

    .btn-secondary {
      background: transparent;
      color: var(--blue);
    }

    .btn-secondary:hover {
      background: rgba(0, 113, 227, 0.08);
    }

    .btn-danger {
      background: transparent;
      color: var(--red);
    }

    .btn-danger:hover {
      background: rgba(255, 59, 48, 0.08);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* Markets Grid */
    .markets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .market-card {
      background: var(--bg);
      border-radius: 14px;
      padding: 20px;
    }

    .market-card.viable {
      background: rgba(52, 199, 89, 0.08);
      outline: 2px solid var(--green);
      outline-offset: -2px;
    }

    .market-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .market-prices {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .price-box {
      flex: 1;
      background: var(--white);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }

    .price-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .price-value {
      font-size: 22px;
      font-weight: 600;
      font-feature-settings: 'tnum';
    }

    .price-value.up { color: var(--green); }
    .price-value.down { color: var(--red); }

    .market-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .viable-tag {
      display: inline-flex;
      padding: 5px 12px;
      background: var(--green);
      color: var(--white);
      font-size: 12px;
      font-weight: 600;
      border-radius: 6px;
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 0.5px solid var(--border);
    }

    .table td {
      padding: 16px;
      font-size: 15px;
      border-bottom: 0.5px solid var(--border);
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .table tr:hover td {
      background: var(--bg);
    }

    .trade-market {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .trade-side {
      font-weight: 600;
    }

    .trade-side.up { color: var(--green); }
    .trade-side.down { color: var(--red); }

    .trade-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .trade-status.open { background: rgba(0, 113, 227, 0.12); color: var(--blue); }
    .trade-status.resolved { background: rgba(52, 199, 89, 0.12); color: var(--green); }
    .trade-status.failed { background: rgba(255, 59, 48, 0.12); color: var(--red); }

    /* Empty State */
    .empty {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty p {
      font-size: 15px;
    }

    /* Claim Section */
    .claim-box {
      background: var(--bg);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .claim-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 14px;
    }

    .claim-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .claim-select,
    .claim-input {
      padding: 10px 14px;
      border: 0.5px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      background: var(--white);
    }

    .claim-input {
      flex: 1;
      min-width: 200px;
      font-family: 'SF Mono', 'Menlo', monospace;
      font-size: 13px;
    }

    .claim-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Tab Panels */
    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Toast */
    .toast-area {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
    }

    .toast {
      background: var(--text);
      color: var(--white);
      padding: 14px 24px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: toastIn 0.3s ease;
    }

    .toast.error {
      background: var(--red);
    }

    @keyframes toastIn {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mono */
    .mono {
      font-family: 'SF Mono', 'Menlo', monospace;
      font-feature-settings: 'tnum';
    }

    /* Settings */
    .settings-section {
      margin-bottom: 32px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .volatility-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    @media (max-width: 640px) {
      .volatility-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="logo">Polymarket</div>
      <div class="header-actions">
        <input type="password" id="passwordInput" class="password-field" placeholder="Password">
        <div id="botStatus" class="status">
          <span class="status-dot"></span>
          <span>Disconnected</span>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <button class="nav-link active" data-tab="btc">Bitcoin</button>
      <button class="nav-link" data-tab="eth">Ethereum</button>
      <button class="nav-link" data-tab="settings">Settings</button>
    </nav>

    <!-- BTC Panel -->
    <div id="btc-panel" class="panel active">
      <!-- Stats -->
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="totalPnL">$0</div>
          <div class="stat-label">Total P&L</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="totalTrades">0</div>
          <div class="stat-label">Trades</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="activePositions">0</div>
          <div class="stat-label">Positions</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="lastScan">‚Äî</div>
          <div class="stat-label">Last Scan</div>
        </div>
      </div>

      <!-- Trading Window -->
      <div class="window-status">
        <div class="window-info">
          <span class="window-icon" id="windowIcon">‚è∞</span>
          <div class="window-text">
            <strong id="windowStatus">Window Closed</strong>
            <span id="windowDetails">Opens at minute 45</span>
          </div>
        </div>
        <div class="window-time">
          <span class="minute-display" id="currentMinute">00</span>
          <span id="windowPill" class="window-pill waiting">Waiting</span>
        </div>
      </div>

      <!-- BTC Controls -->
      <div class="card">
        <h2 class="card-title">Bitcoin</h2>
        <div class="form-row">
          <div>
            <div class="form-label">Enable Trading</div>
            <div class="form-sublabel">Auto-buy when price reaches threshold</div>
          </div>
          <div id="btcToggle" class="toggle" onclick="toggleCrypto('BTC')"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Bet Size</label>
            <input type="number" id="btcBetSizeInput" class="field-input" value="90" min="1">
          </div>
          <div class="field">
            <label class="field-label">Min Price (¬¢)</label>
            <input type="number" id="btcMinPriceInput" class="field-input" value="90" min="50" max="99">
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-secondary" onclick="saveCryptoConfig('BTC')">Save</button>
          <button class="btn btn-primary" onclick="forceScanCrypto('BTC')">Scan Markets</button>
        </div>
      </div>

      <!-- Live Markets -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 class="card-title" style="margin-bottom: 0;">Markets</h2>
          <button class="btn btn-secondary" id="refreshMarketsBtn">Refresh</button>
        </div>
        <div id="liveMarketsContainer">
          <div class="empty">
            <div class="empty-icon">üìä</div>
            <p>No markets. Click Scan Markets to fetch.</p>
          </div>
        </div>
      </div>

      <!-- Cash Out -->
      <div class="card">
        <h2 class="card-title">Cash Out</h2>
        <div class="claim-box">
          <div class="claim-title">Market Sell All Positions</div>
          <div class="form-sublabel" style="margin-bottom: 12px;">Instantly sell all open positions at current market price</div>
          <button class="btn btn-danger" id="cashOutBtn">Cash Out All</button>
        </div>
      </div>

      <!-- Claim -->
      <div class="card">
        <h2 class="card-title">Claim Winnings</h2>
        <div class="claim-box">
          <div class="claim-title">Bulk Claim</div>
          <div class="claim-row">
            <select id="claimDaysBack" class="claim-select">
              <option value="3">Last 3 days</option>
              <option value="7" selected>Last 7 days</option>
              <option value="14">Last 14 days</option>
            </select>
            <button class="btn btn-primary" id="bulkClaimBtn">Claim All</button>
          </div>
        </div>
        <div class="claim-box">
          <div class="claim-title">Manual Claim</div>
          <div class="claim-row">
            <input type="text" id="manualConditionId" class="claim-input" placeholder="Condition ID (0x...)">
            <label class="claim-checkbox">
              <input type="checkbox" id="negRiskCheckbox"> Neg Risk
            </label>
            <button class="btn btn-secondary" id="manualClaimBtn">Claim</button>
          </div>
        </div>
      </div>

      <!-- Trades -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 class="card-title" style="margin-bottom: 0;">Trades</h2>
          <div class="btn-row" style="margin-top: 0;">
            <button class="btn btn-secondary" id="refreshTradesBtn">Refresh</button>
            <button class="btn btn-secondary" id="exportCsvBtn">Export</button>
          </div>
        </div>
        <div id="tradesContainer">
          <div class="empty">
            <div class="empty-icon">üì≠</div>
            <p>No trades yet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ETH Panel -->
    <div id="eth-panel" class="panel">
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="ethTotalPnL">$0</div>
          <div class="stat-label">Total P&L</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="ethTotalTrades">0</div>
          <div class="stat-label">Trades</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="ethActivePositions">0</div>
          <div class="stat-label">Positions</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="ethLastScan">‚Äî</div>
          <div class="stat-label">Last Scan</div>
        </div>
      </div>

      <div class="card">
        <h2 class="card-title">Ethereum</h2>
        <div class="form-row">
          <div>
            <div class="form-label">Enable Trading</div>
            <div class="form-sublabel">Auto-buy when price reaches threshold</div>
          </div>
          <div id="ethToggle" class="toggle" onclick="toggleCrypto('ETH')"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Bet Size</label>
            <input type="number" id="ethBetSizeInput" class="field-input" value="90" min="1">
          </div>
          <div class="field">
            <label class="field-label">Min Price (¬¢)</label>
            <input type="number" id="ethMinPriceInput" class="field-input" value="90" min="50" max="99">
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-secondary" onclick="saveCryptoConfig('ETH')">Save</button>
          <button class="btn btn-primary" onclick="forceScanCrypto('ETH')">Scan Markets</button>
        </div>
      </div>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 class="card-title" style="margin-bottom: 0;">Markets</h2>
          <button class="btn btn-secondary" onclick="fetchCryptoMarkets('ETH')">Refresh</button>
        </div>
        <div id="ethMarketsContainer">
          <div class="empty">
            <div class="empty-icon">Œû</div>
            <p>No markets. Click Scan Markets to fetch.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="panel">
      <!-- Global Controls -->
      <div class="card">
        <h2 class="card-title">Global</h2>
        <div class="form-row">
          <div>
            <div class="form-label">Master Enable</div>
            <div class="form-sublabel">Global on/off for all trading</div>
          </div>
          <div id="globalToggle" class="toggle" onclick="toggleGlobal()"></div>
        </div>
        <div class="btn-row">
          <button class="btn btn-secondary" id="approveBtn">Approve USDC</button>
          <button class="btn btn-secondary" id="approveSellBtn">Approve Selling</button>
          <button class="btn btn-danger" id="emergencyStopBtn">Emergency Stop</button>
        </div>
      </div>

      <!-- Trading Defaults -->
      <div class="card">
        <h2 class="card-title">Trading Defaults</h2>
        
        <!-- BTC -->
        <div class="form-row">
          <div>
            <div class="form-label">‚Çø Bitcoin</div>
            <div class="form-sublabel">Enable BTC trading on startup</div>
          </div>
          <div id="settingsBtcToggle" class="toggle on"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">BTC Bet Size ($)</label>
            <input type="number" id="settingsBtcBetSize" class="field-input" value="90" min="1">
          </div>
          <div class="field">
            <label class="field-label">BTC Min Price (¬¢)</label>
            <input type="number" id="settingsBtcMinPrice" class="field-input" value="90" min="50" max="99">
          </div>
          <div class="field">
            <label class="field-label">BTC Max Price (¬¢)</label>
            <input type="number" id="settingsBtcMaxPrice" class="field-input" value="94" min="50" max="99">
          </div>
        </div>
        
        <!-- ETH -->
        <div class="form-row" style="margin-top: 16px;">
          <div>
            <div class="form-label">Œû Ethereum</div>
            <div class="form-sublabel">Enable ETH trading on startup</div>
          </div>
          <div id="settingsEthToggle" class="toggle"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">ETH Bet Size ($)</label>
            <input type="number" id="settingsEthBetSize" class="field-input" value="90" min="1">
          </div>
          <div class="field">
            <label class="field-label">ETH Min Price (¬¢)</label>
            <input type="number" id="settingsEthMinPrice" class="field-input" value="90" min="50" max="99">
          </div>
          <div class="field">
            <label class="field-label">ETH Max Price (¬¢)</label>
            <input type="number" id="settingsEthMaxPrice" class="field-input" value="94" min="50" max="99">
          </div>
        </div>
      </div>

      <!-- Trading Window -->
      <div class="card">
        <h2 class="card-title">Trading Window</h2>
        <div class="form-sublabel" style="margin-bottom: 16px;">Only execute trades during these minutes of each hour</div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Start Minute (0-59)</label>
            <input type="number" id="settingsWindowStart" class="field-input" value="45" min="0" max="59">
          </div>
          <div class="field">
            <label class="field-label">End Minute (0-59)</label>
            <input type="number" id="settingsWindowEnd" class="field-input" value="59" min="0" max="59">
          </div>
        </div>
      </div>

      <!-- Stop-Loss -->
      <div class="card">
        <h2 class="card-title">Stop-Loss</h2>
        <div class="form-row">
          <div>
            <div class="form-label">Enable Stop-Loss</div>
            <div class="form-sublabel">Auto-sell when price drops below threshold</div>
          </div>
          <div id="settingsStopLossToggle" class="toggle on"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Threshold (¬¢)</label>
            <input type="number" id="settingsStopLossThreshold" class="field-input" value="70" min="10" max="90" step="5">
          </div>
        </div>
        <div class="btn-row">
          <button class="btn btn-danger" onclick="triggerStopLossCheck()">Check Now</button>
        </div>
      </div>

      <!-- Auto-Claim -->
      <div class="card">
        <h2 class="card-title">Auto-Claim</h2>
        <div class="form-row">
          <div>
            <div class="form-label">Enable Auto-Claim</div>
            <div class="form-sublabel">Automatically claim resolved positions</div>
          </div>
          <div id="settingsAutoClaimToggle" class="toggle on"></div>
        </div>
        <div class="form-row">
          <div>
            <div class="form-label">BTC Auto-Claim</div>
            <div class="form-sublabel">Claim BTC market winnings</div>
          </div>
          <div id="settingsBtcClaimToggle" class="toggle on"></div>
        </div>
        <div class="form-row">
          <div>
            <div class="form-label">ETH Auto-Claim</div>
            <div class="form-sublabel">Claim ETH market winnings</div>
          </div>
          <div id="settingsEthClaimToggle" class="toggle"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Check Interval (minutes)</label>
            <input type="number" id="settingsClaimInterval" class="field-input" value="60" min="5" max="1440">
          </div>
          <div class="field">
            <label class="field-label">Days Back</label>
            <input type="number" id="settingsClaimDays" class="field-input" value="7" min="1" max="30">
          </div>
        </div>
      </div>

      <!-- Volatility Filter -->
      <div class="card">
        <h2 class="card-title">Volatility Filter</h2>
        <div class="form-row">
          <div>
            <div class="form-label">Enable Volatility Filter</div>
            <div class="form-sublabel">Skip trades during volatile conditions</div>
          </div>
          <div id="settingsVolatilityToggle" class="toggle"></div>
        </div>
        <div class="form-row">
          <div>
            <div class="form-label">Skip Volatile Hours</div>
            <div class="form-sublabel">Avoid 9-10 AM, 3-4 PM ET</div>
          </div>
          <div id="settingsVolatileHoursToggle" class="toggle"></div>
        </div>
        <div class="form-row">
          <div>
            <div class="form-label">Check Real-time Volatility</div>
            <div class="form-sublabel">Binance price swing detection</div>
          </div>
          <div id="settingsRealtimeToggle" class="toggle"></div>
        </div>
        <div class="form-row">
          <div>
            <div class="form-label">Check Spread</div>
            <div class="form-sublabel">Skip wide bid-ask spreads</div>
          </div>
          <div id="settingsSpreadToggle" class="toggle"></div>
        </div>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Max Volatility (%)</label>
            <input type="number" id="settingsMaxVolatility" class="field-input" value="2.0" step="0.5" min="0.5" max="10">
          </div>
          <div class="field">
            <label class="field-label">Max Spread (¬¢)</label>
            <input type="number" id="settingsMaxSpread" class="field-input" value="5" step="1" min="1" max="20">
          </div>
        </div>
      </div>

      <!-- Advanced -->
      <div class="card">
        <h2 class="card-title">Advanced</h2>
        <div class="input-row">
          <div class="field">
            <label class="field-label">Scan Interval (seconds)</label>
            <input type="number" id="settingsScanInterval" class="field-input" value="5" min="1" max="60">
          </div>
          <div class="field">
            <label class="field-label">Gas Speed</label>
            <select id="settingsGasSpeed" class="field-input" style="font-family: inherit;">
              <option value="safeLow">Slow (cheaper)</option>
              <option value="standard" selected>Standard</option>
              <option value="fast">Fast (expensive)</option>
            </select>
          </div>
        </div>
        <div class="field" style="margin-top: 16px;">
          <label class="field-label">Custom RPC URL (leave empty for default)</label>
          <input type="text" id="settingsRpcUrl" class="field-input" placeholder="https://polygon-rpc.com" style="font-size: 14px;">
        </div>
      </div>

      <!-- Save / Reset / Export -->
      <div class="card">
        <h2 class="card-title">Save & Export</h2>
        <div class="btn-row" style="flex-wrap: wrap; gap: 12px;">
          <button class="btn btn-primary" onclick="saveAllSettings()">Save All Settings</button>
          <button class="btn btn-secondary" onclick="resetToFactory()">Reset to Factory</button>
          <button class="btn btn-secondary" onclick="exportSettings()">Export JSON</button>
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import JSON</button>
          <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSettings(event)">
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastArea" class="toast-area"></div>

  <script>
    let password = localStorage.getItem('botPassword') || '';
    let isConnected = false;
    let allSettings = null; // Will hold all settings from API

    const passwordInput = document.getElementById('passwordInput');
    passwordInput.value = password;
    if (password) fetchStats();

    passwordInput.addEventListener('input', (e) => {
      password = e.target.value;
      localStorage.setItem('botPassword', password);
      fetchStats();
    });

    // Tab switching
    document.querySelectorAll('.nav-link').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`${btn.dataset.tab}-panel`).classList.add('active');
      });
    });

    setInterval(updateTradingWindow, 1000);
    updateTradingWindow();

    document.getElementById('emergencyStopBtn')?.addEventListener('click', emergencyStop);
    document.getElementById('resetBtn')?.addEventListener('click', resetBot);
    document.getElementById('approveBtn')?.addEventListener('click', approveUsdc);
    document.getElementById('approveSellBtn')?.addEventListener('click', approveSelling);
    document.getElementById('refreshTradesBtn')?.addEventListener('click', fetchStats);
    document.getElementById('refreshMarketsBtn')?.addEventListener('click', fetchLiveMarkets);
    document.getElementById('cashOutBtn')?.addEventListener('click', cashOutAll);
    document.getElementById('bulkClaimBtn')?.addEventListener('click', bulkClaimAllHourly);
    document.getElementById('manualClaimBtn')?.addEventListener('click', manualClaimPosition);
    document.getElementById('exportCsvBtn')?.addEventListener('click', exportTradesToCsv);

    async function apiCall(endpoint, method = 'GET', body = null) {
      try {
        const opts = { method, headers: { 'Authorization': `Bearer ${password}`, 'Content-Type': 'application/json' }};
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(`/api${endpoint}`, opts);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'API Error');
        isConnected = true;
        updateStatus(true);
        return data;
      } catch (e) {
        if (e.message === 'Unauthorized') { isConnected = false; updateStatus(false); }
        throw e;
      }
    }

    function updateStatus(connected) {
      const el = document.getElementById('botStatus');
      el.className = `status ${connected ? 'connected' : ''}`;
      el.innerHTML = `<span class="status-dot"></span><span>${connected ? 'Connected' : 'Disconnected'}</span>`;
    }

    async function fetchStats() {
      try {
        const { data } = await apiCall('/stats');
        updateDashboard(data);
        fetchAllCryptoMarkets();
        fetchAllCryptoSettings();
        fetchAllSettings();
      } catch (e) { console.error(e); }
    }

    function updateDashboard(data) {
      const pnl = data.status.totalPnL || 0;
      ['', 'eth'].forEach(p => {
        const pnlEl = document.getElementById(p ? `${p}TotalPnL` : 'totalPnL');
        if (pnlEl) { pnlEl.textContent = `$${pnl.toFixed(0)}`; pnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`; }
        const tEl = document.getElementById(p ? `${p}TotalTrades` : 'totalTrades');
        if (tEl) tEl.textContent = data.status.totalTrades;
        const posEl = document.getElementById(p ? `${p}ActivePositions` : 'activePositions');
        if (posEl) posEl.textContent = data.status.activePositions;
        const scanEl = document.getElementById(p ? `${p}LastScan` : 'lastScan');
        if (scanEl) scanEl.textContent = data.status.lastScan ? formatTime(data.status.lastScan) : '‚Äî';
      });
      updateGlobalToggle(data.config.botEnabled);
      renderTrades(data.recentTrades);
    }

    function updateGlobalToggle(on) {
      const el = document.getElementById('globalToggle');
      if (el) el.className = `toggle ${on ? 'on' : ''}`;
    }

    function updateTradingWindow() {
      const m = new Date().getMinutes();
      const open = m >= 45 && m <= 59;
      document.getElementById('currentMinute').textContent = m.toString().padStart(2, '0');
      const pill = document.getElementById('windowPill');
      const icon = document.getElementById('windowIcon');
      const status = document.getElementById('windowStatus');
      const details = document.getElementById('windowDetails');
      if (open) {
        pill.className = 'window-pill active'; pill.textContent = 'Active';
        icon.textContent = '‚úÖ'; status.textContent = 'Window Open';
        details.textContent = `${59 - m + 1}m remaining`;
      } else {
        pill.className = 'window-pill waiting'; pill.textContent = 'Waiting';
        icon.textContent = '‚è∞'; status.textContent = 'Window Closed';
        details.textContent = `Opens in ${45 - m}m`;
      }
    }

    async function toggleBot() {
      try {
        const { data } = await apiCall('/bot/toggle', 'POST');
        updateGlobalToggle(data.enabled);
        toast(data.enabled ? 'Bot enabled' : 'Bot disabled');
      } catch (e) { toast('Failed', true); }
    }

    async function toggleCrypto(c) {
      try {
        const { data } = await apiCall(`/crypto/${c}/toggle`, 'POST');
        document.getElementById(`${c.toLowerCase()}Toggle`).className = `toggle ${data.enabled ? 'on' : ''}`;
        toast(`${c} ${data.enabled ? 'enabled' : 'disabled'}`);
      } catch (e) { toast('Failed', true); }
    }

    async function saveCryptoConfig(c) {
      try {
        const betSize = parseFloat(document.getElementById(`${c.toLowerCase()}BetSizeInput`).value);
        const minPrice = parseFloat(document.getElementById(`${c.toLowerCase()}MinPriceInput`).value) / 100;
        await apiCall(`/crypto/${c}/settings`, 'POST', { betSize, minPrice });
        toast(`${c} saved`);
      } catch (e) { toast('Failed', true); }
    }

    async function forceScanCrypto(c) {
      try {
        toast(`Scanning ${c}...`);
        const { data } = await apiCall(`/bot/scan/${c}`, 'POST');
        toast(`${data.markets} markets, ${data.opportunities} opps`);
        await fetchSingleCryptoMarkets(c);
      } catch (e) { toast(`Failed: ${e.message}`, true); }
    }

    async function fetchSingleCryptoMarkets(c) {
      try {
        const { data } = await apiCall(`/markets/live/${c}`);
        renderMarkets(data, c);
      } catch (e) { console.error(e); }
    }

    async function fetchAllCryptoMarkets() {
      try {
        const { data } = await apiCall('/markets/live-all');
        ['BTC', 'ETH'].forEach(c => { if (data[c]) renderMarkets(data[c], c); });
      } catch (e) { console.error(e); }
    }

    async function fetchAllCryptoSettings() {
      try {
        const { data } = await apiCall('/crypto/all-settings');
        updateGlobalToggle(data.globalEnabled);
        for (const [c, s] of Object.entries(data.cryptos)) {
          document.getElementById(`${c.toLowerCase()}Toggle`).className = `toggle ${s.enabled ? 'on' : ''}`;
          const bet = document.getElementById(`${c.toLowerCase()}BetSizeInput`);
          const min = document.getElementById(`${c.toLowerCase()}MinPriceInput`);
          if (bet) bet.value = s.betSize;
          if (min) min.value = Math.round(s.minPrice * 100);
        }
      } catch (e) { console.error(e); }
    }

    async function fetchLiveMarkets() {
      try {
        const { data } = await apiCall('/markets/live');
        renderMarkets(data, 'BTC');
      } catch (e) { console.error(e); }
    }

    function renderMarkets(markets, crypto) {
      const id = crypto === 'BTC' ? 'liveMarketsContainer' : `${crypto.toLowerCase()}MarketsContainer`;
      const el = document.getElementById(id);
      if (!el) return;
      if (!markets || !markets.length) {
        el.innerHTML = `<div class="empty"><div class="empty-icon">üìä</div><p>No markets.</p></div>`;
        return;
      }
      markets.sort((a, b) => b.isViable - a.isViable || a.hoursLeft - b.hoursLeft);
      el.innerHTML = `<div class="markets-grid">${markets.map(m => `
        <div class="market-card ${m.isViable ? 'viable' : ''}">
          <div class="market-title" title="${m.title}">${m.title}</div>
          <div class="market-prices">
            <div class="price-box">
              <div class="price-label">Up</div>
              <div class="price-value up">${(m.upPrice * 100).toFixed(0)}¬¢</div>
            </div>
            <div class="price-box">
              <div class="price-label">Down</div>
              <div class="price-value down">${(m.downPrice * 100).toFixed(0)}¬¢</div>
            </div>
          </div>
          <div class="market-footer">
            <span class="mono">${(m.combinedCost * 100).toFixed(0)}¬¢</span>
            <span>${m.hoursLeft.toFixed(1)}h</span>
          </div>
          ${m.isViable ? `<div style="margin-top: 12px;"><span class="viable-tag">Buy ${m.viableSide?.toUpperCase()}</span></div>` : ''}
        </div>
      `).join('')}</div>`;
    }

    function renderTrades(trades) {
      const el = document.getElementById('tradesContainer');
      if (!el) return;
      if (!trades || !trades.length) {
        el.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><p>No trades.</p></div>`;
        return;
      }
      el.innerHTML = `<div class="table-wrapper"><table class="table"><thead><tr><th>Market</th><th>Side</th><th>Price</th><th>Cost</th><th>Status</th><th>P&L</th><th>Time</th></tr></thead><tbody>${trades.map(t => {
        const side = t.side || 'up';
        const price = side === 'up' ? t.up_price : t.down_price;
        return `<tr>
          <td class="trade-market" title="${t.market_question || ''}">${t.market_question || '‚Äî'}</td>
          <td class="trade-side ${side}">${side === 'up' ? '‚Üë' : '‚Üì'} ${side.toUpperCase()}</td>
          <td class="mono">${price ? (price * 100).toFixed(0) + '¬¢' : '‚Äî'}</td>
          <td class="mono">${t.combined_cost ? '$' + t.combined_cost.toFixed(0) : '‚Äî'}</td>
          <td><span class="trade-status ${t.status || ''}">${t.status || '‚Äî'}</span></td>
          <td class="mono">${t.pnl != null ? '$' + t.pnl.toFixed(0) : '‚Äî'}</td>
          <td>${formatTime(t.created_at)}</td>
        </tr>`;
      }).join('')}</tbody></table></div>`;
    }

    async function cashOutAll() {
      if (!confirm('CASH OUT: Sell ALL open positions at market price?')) return;
      try {
        toast('Cashing out...');
        const { data } = await apiCall('/positions/cashout', 'POST');
        toast(`Sold ${data.success} positions (${data.failed} failed)`);
        fetchStats();
      } catch (e) { toast('Cash out failed', true); }
    }

    async function bulkClaimAllHourly() {
      const days = parseInt(document.getElementById('claimDaysBack').value) || 7;
      if (!confirm(`Claim all from last ${days} days?`)) return;
      try {
        await apiCall('/positions/claim-all-hourly', 'POST', { daysBack: days });
        toast('Claim started');
      } catch (e) { toast('Failed', true); }
    }

    async function manualClaimPosition() {
      const id = document.getElementById('manualConditionId').value.trim();
      const neg = document.getElementById('negRiskCheckbox').checked;
      if (!id) { toast('Enter ID', true); return; }
      try {
        await apiCall(`/positions/claim/${encodeURIComponent(id)}`, 'POST', { negRisk: neg });
        toast('Claim started');
        document.getElementById('manualConditionId').value = '';
      } catch (e) { toast('Failed', true); }
    }

    async function approveUsdc() {
      try { await apiCall('/bot/approve', 'POST'); toast('Approval started'); } catch (e) { toast('Failed', true); }
    }

    async function approveSelling() {
      try { await apiCall('/bot/approve-sell', 'POST'); toast('Approval started'); } catch (e) { toast('Failed', true); }
    }

    async function emergencyStop() {
      if (!confirm('Stop bot?')) return;
      try { await apiCall('/bot/stop', 'POST'); toast('Stopped'); fetchStats(); } catch (e) { toast('Failed', true); }
    }

    async function resetBot() {
      if (!confirm('Clear history?')) return;
      try { await apiCall('/bot/reset', 'POST'); toast('Reset'); fetchStats(); } catch (e) { toast('Failed', true); }
    }

    function exportTradesToCsv() {
      const link = document.createElement('a');
      link.href = `/api/trades/export?auth=${encodeURIComponent(password)}`;
      link.download = `trades-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      toast('Export started');
    }

    // ==========================================
    // UNIFIED SETTINGS FUNCTIONS
    // ==========================================
    
    async function fetchAllSettings() {
      try {
        const { data } = await apiCall('/settings');
        allSettings = data;
        applySettingsToUI(data);
      } catch (e) { console.error('Failed to fetch settings:', e); }
    }
    
    function applySettingsToUI(s) {
      if (!s) return;
      
      // Global
      setToggle('globalToggle', s.globalBotEnabled);
      
      // BTC
      setToggle('settingsBtcToggle', s.btc.enabled);
      setValue('settingsBtcBetSize', s.btc.betSize);
      setValue('settingsBtcMinPrice', Math.round(s.btc.minPrice * 100));
      setValue('settingsBtcMaxPrice', Math.round(s.btc.maxPrice * 100));
      setToggle('settingsBtcClaimToggle', s.btc.autoClaimEnabled);
      
      // ETH
      setToggle('settingsEthToggle', s.eth.enabled);
      setValue('settingsEthBetSize', s.eth.betSize);
      setValue('settingsEthMinPrice', Math.round(s.eth.minPrice * 100));
      setValue('settingsEthMaxPrice', Math.round(s.eth.maxPrice * 100));
      setToggle('settingsEthClaimToggle', s.eth.autoClaimEnabled);
      
      // Trading Window
      setValue('settingsWindowStart', s.tradingWindow.startMinute);
      setValue('settingsWindowEnd', s.tradingWindow.endMinute);
      
      // Stop-Loss
      setToggle('settingsStopLossToggle', s.stopLoss.enabled);
      setValue('settingsStopLossThreshold', Math.round(s.stopLoss.threshold * 100));
      
      // Auto-Claim
      setToggle('settingsAutoClaimToggle', s.autoClaim.enabled);
      setValue('settingsClaimInterval', s.autoClaim.intervalMinutes);
      setValue('settingsClaimDays', s.autoClaim.daysBack);
      
      // Volatility
      setToggle('settingsVolatilityToggle', s.volatility.enabled);
      setToggle('settingsVolatileHoursToggle', s.volatility.skipVolatileHours);
      setToggle('settingsRealtimeToggle', s.volatility.checkRealTimeVolatility);
      setToggle('settingsSpreadToggle', s.volatility.checkSpread);
      setValue('settingsMaxVolatility', s.volatility.maxHourlyVolatilityPercent);
      setValue('settingsMaxSpread', s.volatility.maxSpreadCents);
      
      // Advanced
      setValue('settingsScanInterval', s.advanced.scanIntervalSeconds);
      setValue('settingsGasSpeed', s.advanced.gas.speed);
      setValue('settingsRpcUrl', s.advanced.rpcUrl || '');
    }
    
    function setToggle(id, value) {
      const el = document.getElementById(id);
      if (el) el.className = `toggle ${value ? 'on' : ''}`;
    }
    
    function setValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value;
    }
    
    function getToggle(id) {
      const el = document.getElementById(id);
      return el ? el.classList.contains('on') : false;
    }
    
    function getValue(id, isNumber = true) {
      const el = document.getElementById(id);
      if (!el) return isNumber ? 0 : '';
      return isNumber ? parseFloat(el.value) || 0 : el.value;
    }
    
    // Toggle handlers for settings page
    function setupSettingsToggles() {
      const toggleIds = [
        'settingsBtcToggle', 'settingsEthToggle', 
        'settingsBtcClaimToggle', 'settingsEthClaimToggle',
        'settingsStopLossToggle', 'settingsAutoClaimToggle',
        'settingsVolatilityToggle', 'settingsVolatileHoursToggle',
        'settingsRealtimeToggle', 'settingsSpreadToggle'
      ];
      toggleIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.onclick = () => el.classList.toggle('on');
      });
    }
    setupSettingsToggles();
    
    async function toggleGlobal() {
      const el = document.getElementById('globalToggle');
      el.classList.toggle('on');
      // Also update via old API for immediate effect
      try {
        await apiCall('/bot/toggle', 'POST');
      } catch (e) { console.error(e); }
    }
    
    function gatherSettingsFromUI() {
      return {
        globalBotEnabled: getToggle('globalToggle'),
        btc: {
          enabled: getToggle('settingsBtcToggle'),
          betSize: getValue('settingsBtcBetSize'),
          minPrice: getValue('settingsBtcMinPrice') / 100,
          maxPrice: getValue('settingsBtcMaxPrice') / 100,
          autoClaimEnabled: getToggle('settingsBtcClaimToggle'),
        },
        eth: {
          enabled: getToggle('settingsEthToggle'),
          betSize: getValue('settingsEthBetSize'),
          minPrice: getValue('settingsEthMinPrice') / 100,
          maxPrice: getValue('settingsEthMaxPrice') / 100,
          autoClaimEnabled: getToggle('settingsEthClaimToggle'),
        },
        tradingWindow: {
          startMinute: getValue('settingsWindowStart'),
          endMinute: getValue('settingsWindowEnd'),
        },
        stopLoss: {
          enabled: getToggle('settingsStopLossToggle'),
          threshold: getValue('settingsStopLossThreshold') / 100,
        },
        autoClaim: {
          enabled: getToggle('settingsAutoClaimToggle'),
          intervalMinutes: getValue('settingsClaimInterval'),
          daysBack: getValue('settingsClaimDays'),
        },
        volatility: {
          enabled: getToggle('settingsVolatilityToggle'),
          skipVolatileHours: getToggle('settingsVolatileHoursToggle'),
          checkRealTimeVolatility: getToggle('settingsRealtimeToggle'),
          checkSpread: getToggle('settingsSpreadToggle'),
          maxHourlyVolatilityPercent: getValue('settingsMaxVolatility'),
          maxSpreadCents: getValue('settingsMaxSpread'),
        },
        advanced: {
          scanIntervalSeconds: getValue('settingsScanInterval'),
          rpcUrl: getValue('settingsRpcUrl', false),
          gas: {
            speed: getValue('settingsGasSpeed', false),
          },
        },
      };
    }
    
    async function saveAllSettings() {
      try {
        const settings = gatherSettingsFromUI();
        await apiCall('/settings', 'POST', settings);
        toast('All settings saved!');
        fetchAllSettings();
      } catch (e) { toast('Failed to save', true); }
    }
    
    async function resetToFactory() {
      if (!confirm('Reset ALL settings to factory defaults?')) return;
      try {
        const { data } = await apiCall('/settings/reset', 'POST');
        allSettings = data;
        applySettingsToUI(data);
        toast('Reset to factory defaults');
      } catch (e) { toast('Reset failed', true); }
    }
    
    function exportSettings() {
      const link = document.createElement('a');
      link.href = `/api/settings/export?auth=${encodeURIComponent(password)}`;
      link.download = 'polymarket-bot-settings.json';
      link.click();
      toast('Settings exported');
    }
    
    async function importSettings(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const json = e.target.result;
          const { data } = await apiCall('/settings/import', 'POST', JSON.parse(json));
          allSettings = data;
          applySettingsToUI(data);
          toast('Settings imported!');
        } catch (err) {
          toast('Import failed: invalid file', true);
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset file input
    }

    function formatTime(iso) {
      const d = new Date(iso);
      const diff = Math.floor((Date.now() - d) / 1000);
      if (diff < 60) return `${diff}s`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
      return d.toLocaleDateString();
    }

    function toast(msg, error = false) {
      const el = document.createElement('div');
      el.className = `toast ${error ? 'error' : ''}`;
      el.innerHTML = `${error ? '‚úï' : '‚úì'} ${msg}`;
      document.getElementById('toastArea').appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 2500);
    }

    // Stop-Loss Check (manual trigger)
    async function triggerStopLossCheck() {
      try {
        toast('Checking positions...');
        const { data } = await apiCall('/stoploss/check', 'POST');
        toast(`Checked ${data.checked} positions, sold ${data.sold}`);
      } catch (e) { toast('Check failed', true); }
    }

    setInterval(() => { if (isConnected) fetchStats(); }, 30000);
  </script>
</body>
</html>
